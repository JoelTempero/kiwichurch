rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get the current user's document
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if user is an admin
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }

    // Check if user is a host
    function isHost() {
      return isAuthenticated() && getUserData().role == 'host';
    }

    // Check if user is admin or host
    function isAdminOrHost() {
      return isAdmin() || isHost();
    }

    // Check if user is a member of a specific gathering
    function isMemberOfGathering(gatheringId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/gatherings/$(gatheringId)/members/$(request.auth.uid));
    }

    // Check if user is host of a specific gathering
    function isHostOfGathering(gatheringId) {
      let gathering = get(/databases/$(database)/documents/gatherings/$(gatheringId)).data;
      return isAuthenticated() && gathering.hostId == request.auth.uid;
    }

    // Check if a gathering is public
    function isPublicGathering(gatheringId) {
      let gathering = get(/databases/$(database)/documents/gatherings/$(gatheringId)).data;
      return gathering.isPublic == true;
    }

    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Users can read their own profile, admins can read all
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());

      // Users can update their own profile (limited fields)
      allow update: if isAuthenticated() && request.auth.uid == userId &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['displayName', 'photoURL', 'preferences', 'updatedAt']);

      // Only admins can create users or update roles
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Public user profiles (limited info for display)
    match /userProfiles/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ============================================
    // GATHERINGS COLLECTION
    // ============================================
    match /gatherings/{gatheringId} {
      // All authenticated users can read gatherings
      allow read: if isAuthenticated();

      // Only admins can create/update/delete gatherings
      allow create, update, delete: if isAdmin();

      // Gathering members subcollection
      match /members/{memberId} {
        // Members can be read by gathering hosts or admins
        allow read: if isHostOfGathering(gatheringId) || isAdmin();

        // Admins and gathering hosts can manage members
        allow write: if isHostOfGathering(gatheringId) || isAdmin();
      }
    }

    // ============================================
    // EVENTS COLLECTION
    // ============================================
    match /events/{eventId} {
      // All authenticated users can read events
      allow read: if isAuthenticated();

      // Admins and hosts can create/update events
      allow create, update: if isAdminOrHost();

      // Only admins can delete events
      allow delete: if isAdmin();

      // RSVPs subcollection
      match /rsvps/{rsvpId} {
        // Users can read all RSVPs for an event
        allow read: if isAuthenticated();

        // Users can create/update their own RSVP
        allow create, update: if isAuthenticated() && request.auth.uid == rsvpId;

        // Users can delete their own RSVP
        allow delete: if isAuthenticated() && request.auth.uid == rsvpId;
      }
    }

    // ============================================
    // KETE (BLOG) COLLECTION
    // ============================================
    match /kete/{postId} {
      // All authenticated users can read kete posts
      // Public posts can also be read without auth (for SEO)
      allow read: if true;

      // Only admins and hosts can create posts
      allow create: if isAdminOrHost() &&
        request.resource.data.authorId == request.auth.uid;

      // Authors can update their own posts, admins can update any
      allow update: if isAuthenticated() &&
        (resource.data.authorId == request.auth.uid || isAdmin());

      // Only admins can delete posts
      allow delete: if isAdmin();

      // Comments on kete posts
      match /comments/{commentId} {
        allow read: if isAuthenticated();

        // Authenticated users can comment
        allow create: if isAuthenticated() &&
          request.resource.data.authorId == request.auth.uid;

        // Users can update/delete their own comments
        allow update, delete: if isAuthenticated() &&
          (resource.data.authorId == request.auth.uid || isAdmin());
      }
    }

    // ============================================
    // MESSAGE BOARDS COLLECTION
    // ============================================
    match /messageBoards/{boardId} {
      // Board structure: boardId = gatheringId

      // Read access based on gathering type
      allow read: if isAuthenticated() &&
        (isPublicGathering(boardId) || isMemberOfGathering(boardId) || isAdmin());

      // Only admins can create/delete boards
      allow create, delete: if isAdmin();

      // Posts within a message board
      match /posts/{postId} {
        // Read based on gathering visibility
        allow read: if isAuthenticated() &&
          (isPublicGathering(boardId) || isMemberOfGathering(boardId) || isAdmin());

        // For PUBLIC gatherings: any authenticated user can post
        // For PRIVATE gatherings: only members can post
        allow create: if isAuthenticated() &&
          request.resource.data.authorId == request.auth.uid &&
          (isPublicGathering(boardId) || isMemberOfGathering(boardId));

        // Authors can update their own posts
        allow update: if isAuthenticated() &&
          (resource.data.authorId == request.auth.uid || isAdmin());

        // Authors and admins can delete posts
        allow delete: if isAuthenticated() &&
          (resource.data.authorId == request.auth.uid || isAdmin());

        // Comments on posts
        match /comments/{commentId} {
          allow read: if isAuthenticated() &&
            (isPublicGathering(boardId) || isMemberOfGathering(boardId) || isAdmin());

          allow create: if isAuthenticated() &&
            request.resource.data.authorId == request.auth.uid &&
            (isPublicGathering(boardId) || isMemberOfGathering(boardId));

          allow update, delete: if isAuthenticated() &&
            (resource.data.authorId == request.auth.uid || isAdmin());
        }
      }
    }

    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // System creates notifications (via Cloud Functions)
      allow create: if false; // Only via admin SDK

      // Users can mark their notifications as read
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);

      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // SITE SETTINGS (Admin only)
    // ============================================
    match /settings/{settingId} {
      allow read: if true; // Public settings readable
      allow write: if isAdmin();
    }

    // ============================================
    // USERNAMES COLLECTION (for username lookup)
    // ============================================
    match /usernames/{username} {
      // Anyone can check if username exists
      allow read: if true;

      // Users can claim unclaimed usernames
      allow create: if isAuthenticated() &&
        request.resource.data.uid == request.auth.uid;

      // Only the owner can delete their username
      allow delete: if isAuthenticated() &&
        resource.data.uid == request.auth.uid;
    }
  }
}
